# Lead Distribution CRM
Мини-CRM для распределения лидов между операторами по источникам.

## Запуск проекта
1. Зависимости:
```bash
pip install -r requirements.txt
```
2. Запуск сервера:

```bash
uvicorn main:app --reload
```
3. API будет доступна по адресу: 
http://localhost:8000/docs
http://localhost:8000/contacts
http://localhost:8000/operators
http://localhost:8000/sources


## Clean Architecture:
1. core - Бизнес-логика:
- entities.py - Бизнес-сущности (Лид, Оператор, Источник и т.д.)
- repositories.py - Интерфейсы для работы с данными

2. data - Работа с данными:
- database.py - Настройка SQLite
- models.py - SQLAlchemy модели для таблиц
- repository.py - Реализация интерфейсов из core для работы с БД

3. app - Use Cases и DTO:
- dtos.py - Модели для API
- use_cases.py - Бизнес-сценарии(распределение лидов, управление операторами)

4. api - Веб-интерфейс:
- endpoints.py - REST API эндпоинты
- dependencies.py - Настройка зависимостей между слоями

## Модель данных
#### Сущности:
Lead (Лид) - конечный клиент
- Идентифицируется по external_id
- Может иметь email и phone для дополнительной идентификации

Operator (Оператор) - сотрудник для обработки обращений
- Имеет статус (active/inactive)
- Имеет лимит по активным обращениям

Source (Источник) - канал поступления обращений (бот)
- Содержит настройки распределения

OperatorSourceWeight (Вес оператора) - настройки распределения
- Связывает оператора с источником
- Определяет вес оператора для случайного выбора

Contact (Обращение) - факт обращения лида
- Связывает лида, источник и оператора
- Имеет статус (new, in_progress, closed)

## Алгоритм распределения
##### Идентификация лида
Лид идентифицируется по external_id. Если лид с таким ID не найден - создается новый.

##### Учет весов операторов
Для каждого источника задаются веса операторов. Алгоритм использует взвешенный случайный выбор:
- Создается список, где каждый оператор представлен количеством раз, равным его весу
- Из этого списка случайно выбирается оператор

##### Учет лимитов нагрузки
Перед распределением проверяется:
- Оператор активен
- Количество активных обращений оператора < его лимита

##### Если подходящих операторов нет
Обращение создается без назначенного оператора (operator_id = null). Такие обращения можно обрабатывать вручную или перераспределять позже.

##### Основные эндпоинты
- POST /api/v1/contacts/ - создание нового обращения
- POST /api/v1/operators/ - создание оператора
- PUT /api/v1/operators/{id}/status - обновление статуса оператора
- PUT /api/v1/sources/{id}/weights - обновление весов операторов для источника
